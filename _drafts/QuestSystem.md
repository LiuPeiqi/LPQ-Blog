---
layout: draft
title: "客服端程序员视角下的任务系统"
date: 2019-04-29
tags: "Game Design"
---

## 任务是什么

我理解的“任务”这个概念可能会对应到包括不限于Task, Mission, Quest这些名词中。如果广义上游戏是对世界的抽象，那么任务就是这个抽象世界里玩家出生、成长、发挥影响力过程中一个又一个的普世目标和存在意义。一方面玩家不得不完成它，另一方面玩家完成了它又会获得这个抽象世界的普世认可。如果狭义上游戏，尤其是RPG游戏，是一个故事，那么任务就是这个故事中一条或多条故事线上的（时间、事件、状态）节点，或驱动后记录玩家历程。

## 当前的任务系统

现行的任务系统不可谓不繁重，区分一个任务是什么就有多个维度：服务器记录的列表类型，封装的逻辑类型，在UI表现时的类型，各种接取方式，能否召唤怪物，能否播放动画等等。以下讨论打算先从逻辑层面入手，视觉表现先放一放。

### 任务的逻辑分类

基于以上假设，我归纳当前我们游戏中的任务系统包含以下逻辑分类。

1. 剧情，这天然是任务系统里的核心元素。
1. 指引，这个比较复杂，它可以是剧情中的一部分，由剧情的串联使玩家建立起对自己角色所拥有能力的认知。又或是游戏本身自己的目标，有义务必须让玩家知道这个抽象世界能做什么。
1. 日常，宏大或遥远的目标容易望而却步，短小重复但重点是积累能力由量变产生质变，小目标适宜达成。
1. 平台期目标，类似于日常，但跨度长了一些，需要几天才能完成的，具有一定的方向性指导。
1. 随机任务，际遇，枯燥世界中的小巧合，增加玩家探索的新鲜感。
1. 合作任务，事件任务，活动任务，如果说以上的任务都是自己与世界之间的关系，那么合作任务是群体参与改造世界的表现。增加玩家之间的参与感以及互动。

### 哪些系统涉及到了任务系统

这些系统是直接或间接跟任务系统有关联的，它们有些是直接引用任务配置，有些依赖任务的一些时间点或进度，有些是直接耦合到任务配置中的。

1. 指引和解锁。与其说这两个系统跟任务有关联，不如说这两个系统依赖一个确切的时间点以及记录进度和状态的能力，恰好任务满足了这两个要求。
1. 探索（区域）、调查和对话。需要记录进度和状态的能力，以及奖励玩家探索的行为。调查、对话这两个系统和任务里的对话令人困惑，任务里的对话有接任务对话，未完成对话，完成对话。对话系统里有分支功能，能提供不同走向。后期任务对话又套用了对话模板，但是UI界面任然是独立的。这是一个开始没设计清晰以及全局规划，后期演化成丑陋功能的问题。既需要地编配置，又需要任务配置，有接取，完成，放弃三个功能。
1. 成就。这个是跟任务双向关联的系统，或者，这个系统其实就是任务系统，理论上不应该独立出现。让它们分离的一个原因是原任务系统配置过于复杂与不清晰。
1. 怪物召唤。利用任务接取，召唤一个只有主角能看到的NPC，以满足剧情等需要。理论上这应该是一个副本功能，但是要在大地图上实现所以这样折中。它存在的问题是如果是只有主角能看到这个NPC，那么其他玩家则会看到主角与看不到的NPC战斗、交互的怪异行为。楚留香、完美世界等游戏对这种需求的处理是在大地图中进入副本区域，问题是进入与退出时NPC状态的衔接不流畅。这个功能是直接耦合到任务配置中的。
1. NPC显隐。为剧情状态服务。
1. 动画播放。任务播放动画，动画播放接取任务。相互利用状态与时间点，经常遇到的问题是在断线重连时，应该以谁为基准重置另一个的状态。这个功能既是是直接耦合到任务配置中的，又有一个单独的枚举配置。
1. 目标追踪、高亮。这个是耦合到任务配置的。
1. 主角的助手（机器人）。以任务接取或完成的时间点驱动助手播放对应的行为。
1. 活动管理器，以活动的开始触发任务，活动结束放弃任务。任务配置引用了活动管理器。

### 遇到的问题与困难

* **潜规则**

这是我认为最致命的一个问题，是工作中几乎是返工最多、被坑次数最多、令人无数次在深夜绝望的一个问题。它的诞生极其简单：“来吧老哥，先这么搞，你加个默认规制不就行了么！” “改一个字段不是还要全部刷数据么，单独加个判断特殊处理一下！” “先跑起来！”然后当遇到错误的时候，大家通常都是一脸懵逼：“之前还是正常的！”
举个例子，在项目早期时，任务目标和任务完成时要显示一句话，于是我们这样实现的：

1. 如果是任务目标，由程序统一规则，按照下列任务目标类型显示
    1. 杀怪，显示：杀怪某某 x/n
    1. 物品，显示：收集物品某某 x/n
    1. ... ...
1. 如果是任务以完成，由程序显示：找到某某某。

是不是很完美？是不是快速实现了原型化？策划很开心，程序很开心，我们都能早下班！直到有一天，有个老哥找到我“老哥，任务目标和完成显示很僵硬，没有带入感，我们能不能自定义一下？哦，原有的默认显示我们就让它存在呗，反正已经做了！”等等，情况没有这么简单，早期定义这个潜规则的时候只有三四条任务目标类型，随着项目的发展与演化，当提到自定义显示的时候已经膨胀到八九条目标类型了，每个类型都要按照其特点（关联不同的表格）做一个默认显示规则，现在又要再做一条可以自定义格式化字符串的逻辑。没关系，没有什么加班不能解决的问题，如果有，那么连着加很多很多天。
需求没有停止，自定义格式化与默认规则并行运行了一个月都很正常，看起来很美好，直到打包的那一个晚上到来，一个错误导致大家进不去游戏了。最后定位到这个错误，发现缘由很简单：默认显示规则要显示**怪物**的名字，而**怪物包**数据没有名字的定义。为什么要引用怪物包的数据而不用怪物数据呢？原因是随着功能的演化，改了需求把怪物配置升级成怪物包配置，当时使用的是自定义格式（没有引用其他数据表）没有出现问题，直到打包前夕使用了一个以为千锤百炼没有问题的潜规则。
这个问题是因为懒惰引起的，如果开始就按照最原子的逻辑去实现，那么返工与Bug就会少一些。上面这个例子只是毛毛多潜规则中的一个，它每次出生的时候都表现的温顺可爱人畜无害，可随着功能的演化，它就会长成一个地雷，然后在每一次打包前后肆意绽放。

* **空白逻辑持续发挥手机余热**

说起来你可能不信，我们有代码上在2017年9月11号就编写了逻辑，然后在今天2019年4月30号还没有使用的功能。任务接取条件：玩家温度上下限。除了这个还有接取时需求技能id数组，也是没有用到的接取条件。极端个例以外，其他大部分是只有少数几个任务使用了的条件被所有任务携带的空白条件逻辑字段。每当打开任务配置表的时候，这些空白逻辑严重的占用了有限的电脑屏幕的宽度，大家在持续烦躁的心情中不断的按下右方向键意图快速的在大海之中找到关键的数据列。客户端程序也痛苦，光接取条件判断就写了200多行。也许服务器更痛苦，因为除了写接取条件，还要写完成条件。
如果它仅仅是安安静静的为手机发热做一点贡献的话，其实也还好，但问题是这些空白逻辑还冷不丁的刷一下存在感：某些配置数据因出生太早，后面加了新的条件后数据文件缺少具体项而报错（空引用error）或者莫名其妙的条件不满足（新加逻辑的同学、原配置任务的同学、程序同学彼此都没有完整的信息而不能直接定位问题，从而浪费大量debug的时间）。

* **完全手动的跨表引用**

跨表不是问题，反而如果按照关系式库的模型来说，最高范式无冗余才是合理的。我们遇到的问题是手动配置各个跨表逻辑的冗余数据。举个配置提交任务的例子：任务配置表里配置了任务完成的提交NPC（服务器不依赖，客户端依赖显示完成提示，还记得一条说的潜规则么！），还需要配置一个提交服务，然后提交服务要加到npc的服务组件里，最后把服务组件填到npc表里。这几个步骤缺一不可，不然分分钟报错给你看。
这样的配表与其他配表耦合度非常高，常常牵一发而动全身。比如地编重新种了NPC并导出，那么其他任务表就要同步修改位置。比如区域触发的任务在区域信息中记录，但是任务配置表里还要记录对应区域的id。

* **导出数据与数据源不一致**

### 工具与流程问题

### 来自于程序方面的问题

1. 浪费
1. 优化或过早的优化

### 任务系统的核心功能

我浅薄的从业经验不足以直接定义出什么是构成任务系统的根本要素。从另一个角度来看，当前任务系统本身以及其他相关联系统对任务提出了哪些要求，这些要求可以归纳出什么样的要素。

## 如果能重来

### 如何简化任务系统的设计

### 如何组合出复杂表现

### 基础逻辑与表现封装

### 奖励与奖励预览

### 追踪与关键信息提示

## 总结
